<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    <title>Fluent Python (4)：控制流程 | PrintXHL | 我就想做一点微小的工作</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#2361b6">
    
    
    <meta name="keywords" content="Python">
    <meta name="description" content="可迭代的对象、迭代器和生成器Sentence类第1版：单词序列实现一个Sentence类，实现序列协议，这个类对象可以迭代 123456789101112131415161718import reimport reprlibRE_WORD = re.compile(&apos;\w+&apos;)class Sentence:    def __init__(self, text):        self.text">
<meta name="keywords" content="Python">
<meta property="og:type" content="article">
<meta property="og:title" content="Fluent Python (4)：控制流程">
<meta property="og:url" content="http://printxhl.com/2018/05/30/Python-FlunetPython-flow/index.html">
<meta property="og:site_name" content="PrintXHL">
<meta property="og:description" content="可迭代的对象、迭代器和生成器Sentence类第1版：单词序列实现一个Sentence类，实现序列协议，这个类对象可以迭代 123456789101112131415161718import reimport reprlibRE_WORD = re.compile(&apos;\w+&apos;)class Sentence:    def __init__(self, text):        self.text">
<meta property="og:updated_time" content="2018-03-29T09:57:49.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Fluent Python (4)：控制流程">
<meta name="twitter:description" content="可迭代的对象、迭代器和生成器Sentence类第1版：单词序列实现一个Sentence类，实现序列协议，这个类对象可以迭代 123456789101112131415161718import reimport reprlibRE_WORD = re.compile(&apos;\w+&apos;)class Sentence:    def __init__(self, text):        self.text">
    
        <link rel="alternate" type="application/atom+xml" title="PrintXHL" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.6.13">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">谢海练</h5>
          <a href="mailto:xiehailian66@126.com" title="xiehailian66@126.com" class="mail">xiehailian66@126.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                Home
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/python"  >
                <i class="icon icon-lg icon-code"></i>
                Python
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/data"  >
                <i class="icon icon-lg icon-database"></i>
                Data
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/book"  >
                <i class="icon icon-lg icon-book"></i>
                Book
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/xiehailian" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Fluent Python (4)：控制流程</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Fluent Python (4)：控制流程</h1>
        <h5 class="subtitle">
            
                <time datetime="2018-05-30T06:55:01.296Z" itemprop="datePublished" class="page-time">
  2018-05-30
</time>


            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#可迭代的对象、迭代器和生成器"><span class="post-toc-number">1.</span> <span class="post-toc-text">可迭代的对象、迭代器和生成器</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Sentence类第1版：单词序列"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">Sentence类第1版：单词序列</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#序列可以迭代的原因：iter函数"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">序列可以迭代的原因：iter函数</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#可迭代对象-vs-迭代器"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">可迭代对象 vs 迭代器</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#可迭代的对象"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">可迭代的对象</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#迭代器"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">迭代器</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Sentence类第2版：典型的迭代器"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">Sentence类第2版：典型的迭代器</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#把Sentence变成迭代器：坏主意"><span class="post-toc-number">1.3.1.</span> <span class="post-toc-text">把Sentence变成迭代器：坏主意</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Sentence类第3版：生成器函数"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">Sentence类第3版：生成器函数</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#生成器函数的工作原理"><span class="post-toc-number">1.4.1.</span> <span class="post-toc-text">生成器函数的工作原理</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Sentence类第4版：惰性实现"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">Sentence类第4版：惰性实现</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Sentence类第5版：生成器表达式"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">Sentence类第5版：生成器表达式</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#何时使用生成器表达式"><span class="post-toc-number">1.7.</span> <span class="post-toc-text">何时使用生成器表达式</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#另一个示例：等差数列生成器"><span class="post-toc-number">1.8.</span> <span class="post-toc-text">另一个示例：等差数列生成器</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用生成器函数实现"><span class="post-toc-number">1.8.1.</span> <span class="post-toc-text">使用生成器函数实现</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用itertools模块生成等差数列"><span class="post-toc-number">1.8.2.</span> <span class="post-toc-text">使用itertools模块生成等差数列</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#yield-from"><span class="post-toc-number">1.9.</span> <span class="post-toc-text">yield from</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#可迭代的归约函数"><span class="post-toc-number">1.10.</span> <span class="post-toc-text">可迭代的归约函数</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#深入分析iter函数"><span class="post-toc-number">1.11.</span> <span class="post-toc-text">深入分析iter函数</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#把生成器当成协程"><span class="post-toc-number">1.12.</span> <span class="post-toc-text">把生成器当成协程</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#上下文管理器和else块"><span class="post-toc-number">2.</span> <span class="post-toc-text">上下文管理器和else块</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#if语句之外else块"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">if语句之外else块</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#上下文管理器和with块"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">上下文管理器和with块</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#contextlib模块中实用工具"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">contextlib模块中实用工具</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#使用-contextmanager"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">使用@contextmanager</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#协程"><span class="post-toc-number">3.</span> <span class="post-toc-text">协程</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#生成器如何进化成协程"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">生成器如何进化成协程</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#用作协程的生成器的基本行为"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">用作协程的生成器的基本行为</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#使用协程计算移动平均值"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">使用协程计算移动平均值</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#预激协程的装饰器"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">预激协程的装饰器</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#终止协程和异常处理"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">终止协程和异常处理</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#让协程返回值"><span class="post-toc-number">3.6.</span> <span class="post-toc-text">让协程返回值</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#使用yield-from"><span class="post-toc-number">3.7.</span> <span class="post-toc-text">使用yield from</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#yield-from的意义"><span class="post-toc-number">3.8.</span> <span class="post-toc-text">yield from的意义</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用future处理并发"><span class="post-toc-number">4.</span> <span class="post-toc-text">使用future处理并发</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#网络下载的三种风格"><span class="post-toc-number">4.1.</span> <span class="post-toc-text">网络下载的三种风格</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用依序下载"><span class="post-toc-number">4.1.1.</span> <span class="post-toc-text">使用依序下载</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用concurrent-futures模块下载"><span class="post-toc-number">4.1.2.</span> <span class="post-toc-text">使用concurrent.futures模块下载</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Future在哪里"><span class="post-toc-number">4.1.3.</span> <span class="post-toc-text">Future在哪里</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#阻塞型IO和GIL"><span class="post-toc-number">4.2.</span> <span class="post-toc-text">阻塞型IO和GIL</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#使用concurrent-futures模块启动进程"><span class="post-toc-number">4.3.</span> <span class="post-toc-text">使用concurrent.futures模块启动进程</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#实验Executor-map方法"><span class="post-toc-number">4.4.</span> <span class="post-toc-text">实验Executor.map方法</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#线程和多进程的替代方案"><span class="post-toc-number">4.5.</span> <span class="post-toc-text">线程和多进程的替代方案</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用asyncio包处理并发"><span class="post-toc-number">5.</span> <span class="post-toc-text">使用asyncio包处理并发</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#线程与协程对比"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">线程与协程对比</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#asynico-Future：故意不阻塞"><span class="post-toc-number">5.1.1.</span> <span class="post-toc-text">asynico.Future：故意不阻塞</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#从期物、任务和协程中产出"><span class="post-toc-number">5.1.2.</span> <span class="post-toc-text">从期物、任务和协程中产出</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#使用asyncio和aiohttp包下载"><span class="post-toc-number">5.2.</span> <span class="post-toc-text">使用asyncio和aiohttp包下载</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#避免阻塞型调用"><span class="post-toc-number">5.3.</span> <span class="post-toc-text">避免阻塞型调用</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#改进asycio下载脚本"><span class="post-toc-number">5.4.</span> <span class="post-toc-text">改进asycio下载脚本</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用asyncio-as-completed函数"><span class="post-toc-number">5.4.1.</span> <span class="post-toc-text">使用asyncio.as_completed函数</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用Executor对象，防止阻塞事件循环"><span class="post-toc-number">5.4.2.</span> <span class="post-toc-text">使用Executor对象，防止阻塞事件循环</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#从回调到期物和协程"><span class="post-toc-number">5.5.</span> <span class="post-toc-text">从回调到期物和协程</span></a></li></ol></li></ol>
        </nav>
    </aside>
    
<article id="post-Python-FlunetPython-flow"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Fluent Python (4)：控制流程</h1>
        <div class="post-meta">
            <time class="post-time" title="2018-05-30 14:55:01" datetime="2018-05-30T06:55:01.296Z"  itemprop="datePublished">2018-05-30</time>

            


            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <h2 id="可迭代的对象、迭代器和生成器"><a href="#可迭代的对象、迭代器和生成器" class="headerlink" title="可迭代的对象、迭代器和生成器"></a>可迭代的对象、迭代器和生成器</h2><h3 id="Sentence类第1版：单词序列"><a href="#Sentence类第1版：单词序列" class="headerlink" title="Sentence类第1版：单词序列"></a>Sentence类第1版：单词序列</h3><p>实现一个<code>Sentence</code>类，实现序列协议，这个类对象可以迭代</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> reprlib</div><div class="line"></div><div class="line">RE_WORD = re.compile(<span class="string">'\w+'</span>)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sentence</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, text)</span>:</span></div><div class="line">        self.text = text</div><div class="line">        self.words = RE_WORD.findall(text)  <span class="comment"># &lt;1&gt;</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__getitem__</span><span class="params">(self, index)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.words[index]  <span class="comment"># &lt;2&gt;</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__len__</span><span class="params">(self, index)</span>:</span>  <span class="comment"># &lt;3&gt;</span></div><div class="line">        <span class="keyword">return</span> len(self.words)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'Sentence(%s)'</span> % reprlib.repr(self.text)  <span class="comment"># &lt;4&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li><code>re.findall</code>函数返回一个字符串列表，里面的元素是正则表达式的全部非重叠匹配</li>
<li><code>self.words</code>中保存的是<code>.findall</code>函数返回的结果，因此直接返回指定索引位上的单词</li>
<li>为了完善序列协议，实现了<code>__len__</code>方法，但是如果只是为了让对象可以迭代，没必要实现这个方法</li>
<li><code>reprlib.repr</code>这个实用函数用于生成大型数据结构的简略字符串表示形式，默认情况下生成的字符串最多有30个字符</li>
</ol>
<h4 id="序列可以迭代的原因：iter函数"><a href="#序列可以迭代的原因：iter函数" class="headerlink" title="序列可以迭代的原因：iter函数"></a>序列可以迭代的原因：iter函数</h4><p>解释器需要迭代对象<code>x</code>时，会自动调用<code>iter(x)</code>函数。<code>iter(x)</code>有以下作用：</p>
<ol>
<li>检查对象是否实现了<code>__iter__</code>方法，如果实现了就调用它，获取一个迭代器</li>
<li>如果没有实现<code>__iter__</code>方法，但实现了<code>__getitem__</code>方法，Python会创建要给迭代器，尝试按顺序获取元素</li>
<li>如果尝试失败，Python抛出<code>TypeError</code>异常，告知你对象不可迭代</li>
</ol>
<h3 id="可迭代对象-vs-迭代器"><a href="#可迭代对象-vs-迭代器" class="headerlink" title="可迭代对象 vs 迭代器"></a>可迭代对象 vs 迭代器</h3><h4 id="可迭代的对象"><a href="#可迭代的对象" class="headerlink" title="可迭代的对象"></a>可迭代的对象</h4><ul>
<li><code>__iter__</code>，实现了此方法，那对象就是可迭代的</li>
<li><code>__getitem__</code>，或者实现了此方法，而且其参数是从零开始索引，那对象也是可迭代的</li>
</ul>
<h4 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h4><ul>
<li><code>__next__</code>，必须实现此方法，返回序列中下一个元素，如果没有元素了，那么就抛出<code>StopIteration</code>异常</li>
<li><code>__iter__</code>，还需要实现此方法，所以迭代器才可以迭代</li>
</ul>
<h3 id="Sentence类第2版：典型的迭代器"><a href="#Sentence类第2版：典型的迭代器" class="headerlink" title="Sentence类第2版：典型的迭代器"></a>Sentence类第2版：典型的迭代器</h3><p>使用迭代器模式实现<code>Sentence</code>类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SentenceIterator</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, words)</span>:</span></div><div class="line">        self.words = words  </div><div class="line">        self.index = <span class="number">0</span>  </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__next__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            word = self.words[self.index]  </div><div class="line">        <span class="keyword">except</span> IndexError</div><div class="line">            <span class="keyword">raise</span> StopIteration()  </div><div class="line">        self.index += <span class="number">1</span>  </div><div class="line">        <span class="keyword">return</span> word  </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span>  </div><div class="line">        <span class="keyword">return</span> self</div></pre></td></tr></table></figure>
<h4 id="把Sentence变成迭代器：坏主意"><a href="#把Sentence变成迭代器：坏主意" class="headerlink" title="把Sentence变成迭代器：坏主意"></a>把Sentence变成迭代器：坏主意</h4><ul>
<li>构建可迭代的对象和迭代器时经常会出现错误，原因是混肴了二者。</li>
<li>迭代器可以迭代，但是可迭代对象不是迭代器。</li>
<li>迭代器一般要支持多种遍历，必须能从同一个可迭代的实例中获取多个独立的迭代器，而且每个迭代器要能维护自身内部状态</li>
<li>这一模式正确的实现方式是，每次调用<code>iter(my_iterable)</code>都新建一个独立迭代器，这就是为什么要重新定义一个<code>SentenceIterator</code>类</li>
</ul>
<h3 id="Sentence类第3版：生成器函数"><a href="#Sentence类第3版：生成器函数" class="headerlink" title="Sentence类第3版：生成器函数"></a>Sentence类第3版：生成器函数</h3><p>生成器可以实现和迭代器相同的功能，用生成器函数来代替<code>SentenceIterator</code>类更符合Python的习惯。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> reprlib</div><div class="line"></div><div class="line">RE_WORD = re.compile(<span class="string">'\w+'</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sentence</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, text)</span>:</span></div><div class="line">        self.text = text</div><div class="line">        self.words = RE_WORD.findall(text)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'Sentence(%s)'</span> % reprlib.repr(self.text)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> self.words:  </div><div class="line">            <span class="keyword">yield</span> word  <span class="comment"># 1</span></div><div class="line">        <span class="keyword">return</span>  <span class="comment"># 2</span></div></pre></td></tr></table></figure>
<ol>
<li>用<code>yield</code>产出当前的<code>word</code></li>
<li>这个<code>return</code>语句是不必要的，这个函数可以直接落空，自动返回。不管有没有<code>return</code>语句，生成器函数都不会抛出<code>StopIteration</code>异常，而是在生成完全部值后直接退出</li>
<li>不再需要单独定义一个迭代器的类！这里的迭代器其实是生成器对象，每次调用<code>__iter__</code>方法都会自动创建，因为这里的<code>__iter__</code>方法是生成器函数</li>
</ol>
<h4 id="生成器函数的工作原理"><a href="#生成器函数的工作原理" class="headerlink" title="生成器函数的工作原理"></a>生成器函数的工作原理</h4><ul>
<li>只要Python函数定义体中有<code>yield</code>关键字，该函数就是<strong>生成器函数</strong>。调用生成器函数时，会返回生成器对象。也就是说，生成器函数是生成器工厂。</li>
<li>生成器函数会创建一个生成器对象，包装生成器函数的定义体。把生成器传给<code>next()</code>函数时，生成器函数就会向前，执行函数定义体中的下一个yield语句，返回产出的值，并在函数定义体的当前位置暂停，最终函数定义体返回时，外层的生成器对象抛出<code>StopIteration</code>异常。</li>
</ul>
<h3 id="Sentence类第4版：惰性实现"><a href="#Sentence类第4版：惰性实现" class="headerlink" title="Sentence类第4版：惰性实现"></a>Sentence类第4版：惰性实现</h3><p>惰性实现是指，尽可能延后生成值，这样做能节省内存，而且或许还可以避免做无用的处理。</p>
<p>之前版本的<code>Sentence</code>类都不具有惰性，因为<code>__init__</code>方法急迫地构建好了文本中的单次列表，然后将其绑定到<code>self.words</code>属性上。这样就得处理整个文本，列表使用的内存量可能与文本本身一样多。如果只需迭代前几个单次，那么大多数工作都是白费力气。</p>
<p>只要使用是<strong>Python 3</strong>，思索着做某件事有没有懒惰的方式，答案通常都是肯定的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> reprlib</div><div class="line"></div><div class="line">RE_WORD = re.compile(<span class="string">'\w+'</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sentence</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, text)</span>:</span></div><div class="line">        self.text = text  <span class="comment"># &lt;1&gt;</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'Sentence(%s)'</span> % reprlib.repr(self.text)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">for</span> match <span class="keyword">in</span> RE_WORD.finditer(self.text):  <span class="comment"># &lt;2&gt;</span></div><div class="line">            <span class="keyword">yield</span> match.group()  <span class="comment"># &lt;3&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li>不再需要<code>words</code>列表</li>
<li><code>re.finditer</code>函数是<code>re.findall</code>函数的惰性版本，返回的不是列表，而是生成器，按需生成<code>re.MatchObject</code>实例。如果有很多匹配，<code>re.finditer</code>函数能节省大量内存。惰性实现可以在需要时才生成一个单词</li>
<li><code>match.group()</code>方法从<code>MathcObject</code>实例中提取匹配正则表达式的具体文本</li>
</ol>
<h3 id="Sentence类第5版：生成器表达式"><a href="#Sentence类第5版：生成器表达式" class="headerlink" title="Sentence类第5版：生成器表达式"></a>Sentence类第5版：生成器表达式</h3><p>生成器表达式可以理解为列表推导惰性版本，不迫切地构建列表，而是返回一个生成器，按需生成元素。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> reprlib</div><div class="line"></div><div class="line">RE_WORD = re.compile(<span class="string">'\w+'</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sentence</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, text)</span>:</span></div><div class="line">        self.text = text</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'Sentence(%s)'</span> % reprlib.repr(self.text)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> (match.group() <span class="keyword">for</span> match <span class="keyword">in</span> RE_WORD.finditer(self.text))</div></pre></td></tr></table></figure>
<h3 id="何时使用生成器表达式"><a href="#何时使用生成器表达式" class="headerlink" title="何时使用生成器表达式"></a>何时使用生成器表达式</h3><p>如果生成器表达式要分开多行写，那就定义生成器函数，以便提高可读性。</p>
<h3 id="另一个示例：等差数列生成器"><a href="#另一个示例：等差数列生成器" class="headerlink" title="另一个示例：等差数列生成器"></a>另一个示例：等差数列生成器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArithmeticProgression</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, begin, step, end=None)</span>:</span>  <span class="comment"># &lt;1&gt;</span></div><div class="line">        self.begin = begin</div><div class="line">        self.step = step</div><div class="line">        self.end = end  <span class="comment"># None -&gt; "infinite" series</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></div><div class="line">        result = type(self.begin + self.step)(self.begin)  <span class="comment"># &lt;2&gt;</span></div><div class="line">        forever = self.end <span class="keyword">is</span> <span class="keyword">None</span>  <span class="comment"># &lt;3&gt;</span></div><div class="line">        index = <span class="number">0</span></div><div class="line">        <span class="keyword">while</span> forever <span class="keyword">or</span> result &lt; self.end:  <span class="comment"># &lt;4&gt;</span></div><div class="line">            <span class="keyword">yield</span> result  <span class="comment"># &lt;5&gt;</span></div><div class="line">            index += <span class="number">1</span></div><div class="line">            result = self.begin + self.step * index  <span class="comment"># &lt;6&gt;</span></div></pre></td></tr></table></figure>
<ol>
<li><code>__init__</code>方法需要两个参数：<code>begin</code>和<code>step</code>。<code>end</code>是可选的，如果值是<code>None</code>，那么生成的是无穷数列</li>
<li>把<code>self.begin</code>赋值给<code>result</code>，不过会先强制转换成前面的加法算式得到类型</li>
<li>如果<code>self.end</code>属性的值是<code>None</code>，那么<code>forever</code>的值是<code>True</code>，因此生成的是无穷数列</li>
<li>这个循环要么一直执行下去，要么当<code>result</code>大于或等于<code>self.end</code>时结束。如果循环退出了，那么这个函数也随之退出</li>
</ol>
<h4 id="使用生成器函数实现"><a href="#使用生成器函数实现" class="headerlink" title="使用生成器函数实现"></a>使用生成器函数实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">aritprog_gen</span><span class="params">(begin, step, end=None)</span>:</span></div><div class="line">    result = type(begin + step)(begin)</div><div class="line">    forever = end <span class="keyword">is</span> <span class="keyword">None</span></div><div class="line">    index = <span class="number">0</span></div><div class="line">    <span class="keyword">while</span> forever <span class="keyword">or</span> result &lt; end:</div><div class="line">        <span class="keyword">yield</span> result</div><div class="line">        index += <span class="number">1</span></div><div class="line">        result = begin + step * index</div></pre></td></tr></table></figure>
<h4 id="使用itertools模块生成等差数列"><a href="#使用itertools模块生成等差数列" class="headerlink" title="使用itertools模块生成等差数列"></a>使用itertools模块生成等差数列</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> itertools</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">aritprog_gen</span><span class="params">(begin, step, end=None)</span>:</span></div><div class="line">    first = type(begin + step)(begin)</div><div class="line">    ap_gen = itertools.count(first, step)   <span class="comment"># 1</span></div><div class="line">    <span class="keyword">if</span> end <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">        ap_gen = itertools.takewhile(<span class="keyword">lambda</span> n: n &lt; end, ap_gen)  <span class="comment"># 2</span></div><div class="line">    <span class="keyword">return</span> ap_gen</div></pre></td></tr></table></figure>
<ol>
<li><code>itertools.count</code>函数返回的生成器能生成多个数，且从不停止</li>
<li><code>itertools.takewhile</code>函数会生成一个使用另一个生成器生成器，在指定的条件计算结果为<code>False</code>时停止</li>
</ol>
<h3 id="yield-from"><a href="#yield-from" class="headerlink" title="yield from"></a>yield from</h3><p><code>yield from i</code>完全可以代替内层的<code>for</code>循环</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">chain</span><span class="params">(*iterables)</span>:</span></div><div class="line"><span class="meta">... </span>	<span class="keyword">for</span> i <span class="keyword">in</span> iterables:</div><div class="line"><span class="meta">... </span>		<span class="keyword">yield</span> <span class="keyword">from</span> i</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>list(chain(s, t))</div><div class="line">[<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]</div></pre></td></tr></table></figure>
<h3 id="可迭代的归约函数"><a href="#可迭代的归约函数" class="headerlink" title="可迭代的归约函数"></a>可迭代的归约函数</h3><p>接受可迭代对象作为参数，最终返回单个结果</p>
<p><code>all</code>，<code>any</code>，<code>max</code>，<code>min</code>，<code>sum</code>，<code>functools.reduce</code></p>
<h3 id="深入分析iter函数"><a href="#深入分析iter函数" class="headerlink" title="深入分析iter函数"></a>深入分析iter函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">d6</span><span class="params">()</span>:</span></div><div class="line">...		<span class="keyword">return</span> randint(<span class="number">1</span>, <span class="number">6</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>d6_iter = iter(d6)   <span class="comment"># 1</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>d6_iter = iter(d6, <span class="number">1</span>)   <span class="comment"># 2</span></div></pre></td></tr></table></figure>
<ol>
<li>迭代对象<code>d6</code>时会调用<code>iter(d6)</code></li>
<li>传入两个参数，第一个参数必须是可调用的对象，第二个值是哨符。当可调用对象返回这个值时，触发迭代器抛出<code>StopIteration</code>异常，而不产生哨符</li>
</ol>
<h3 id="把生成器当成协程"><a href="#把生成器当成协程" class="headerlink" title="把生成器当成协程"></a>把生成器当成协程</h3><ul>
<li><code>.send()</code>方法允许在客户代码和生成器之间双向交换数据</li>
<li><code>.__next__()</code>方法只允许客户从生成器中获取数据</li>
</ul>
<h2 id="上下文管理器和else块"><a href="#上下文管理器和else块" class="headerlink" title="上下文管理器和else块"></a>上下文管理器和else块</h2><h3 id="if语句之外else块"><a href="#if语句之外else块" class="headerlink" title="if语句之外else块"></a>if语句之外else块</h3><p>在所有情况下，如果异常或者<code>return</code>、<code>break</code>或<code>continue</code>语句导致控制权跳到了复合语句的主块之外，<code>else</code>子句也会被跳过</p>
<ul>
<li><p><code>for...else</code></p>
<p>仅当<code>for</code>循环运行完毕时，即<code>for</code>循环没有被<code>break</code>语句终止时才运行<code>else</code>块</p>
</li>
<li><p><code>while...else</code></p>
<p>仅当<code>while</code>循环因为条件为假值而推出时，即<code>while</code>循环没有被<code>break</code>语句终止才运行<code>else</code>块</p>
</li>
<li><p><code>try...else</code></p>
<p>仅当<code>try</code>块没有异常抛出时才运行<code>else</code>块</p>
</li>
</ul>
<h3 id="上下文管理器和with块"><a href="#上下文管理器和with块" class="headerlink" title="上下文管理器和with块"></a>上下文管理器和with块</h3><p>上下文管理器对象存在的目的是管理<code>with</code>语句，就像迭代器的存在是为了管理<code>for</code>语句一样。</p>
<p><code>with</code>语句的目的是简化<code>try/finally</code>模式。这种模式用于保证一段代码运行完毕后执行某项操作，即便那段代码由于异常、<code>return</code>语句或<code>sys.exit()</code>调用而终止，也会执行指定操作。<code>finally</code>子句中的代码通常用于释放重要资源，或者还原临时变更的状态。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LookingGlass</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__enter__</span><span class="params">(self)</span>:</span>  <span class="comment"># &lt;1&gt;</span></div><div class="line">        <span class="keyword">import</span> sys</div><div class="line">        self.original_write = sys.stdout.write  <span class="comment"># &lt;2&gt;</span></div><div class="line">        sys.stdout.write = self.reverse_write  <span class="comment"># &lt;3&gt;</span></div><div class="line">        <span class="keyword">return</span> <span class="string">'JABBERWOCKY'</span>  </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverse_write</span><span class="params">(self, text)</span>:</span>  </div><div class="line">        self.original_write(text[::<span class="number">-1</span>])</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__exit__</span><span class="params">(self, exc_type, exc_value, traceback)</span>:</span>  <span class="comment"># &lt;4&gt;</span></div><div class="line">        <span class="keyword">import</span> sys  <span class="comment"># &lt;5&gt;</span></div><div class="line">        sys.stdout.write = self.original_write  <span class="comment"># &lt;6&gt;</span></div><div class="line">        <span class="keyword">if</span> exc_type <span class="keyword">is</span> ZeroDivisionError:  <span class="comment"># &lt;7&gt;</span></div><div class="line">            print(<span class="string">'Please DO NOT divide by zero!'</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">True</span></div></pre></td></tr></table></figure>
<ol>
<li><code>with</code>语句开始运行时，会在上下文管理器对象上调用<code>__enter__</code>方法。除了<code>self</code>之外，调用<code>__enter__</code>方法时不传入其他参数</li>
<li>把原来的<code>sys.stdout.write</code>方法保存在一个实例属性中，供后面使用</li>
<li>为<code>sys.stdout.write</code>打猴子补丁，替换成自己编写方法</li>
<li><code>with</code>语句运行结束后，会在上下文管理器对象调用<code>__exit__</code>方法，以此扮演<code>finally</code>子句的角色。如果一切正常，调用<code>__exit__</code>方法传入参数是全是<code>None</code>。如果抛出了异常，这个三个参数是异常数据</li>
<li>重复导入模块不会消耗很多资源，因为Python会缓存导入模块</li>
<li>还原成原来的<code>sys.stdout.write</code>方法</li>
<li>如果有异常，而且是<code>ZeroDivisionError</code>类型，打印一个消息，然后返回<code>True</code>，告诉解释器，异常已经处理</li>
</ol>
<h3 id="contextlib模块中实用工具"><a href="#contextlib模块中实用工具" class="headerlink" title="contextlib模块中实用工具"></a>contextlib模块中实用工具</h3><p>使用<code>contextlib</code>自定义上下文管理器</p>
<ul>
<li><code>closing</code></li>
<li><code>suppress</code></li>
<li><code>@contextmanager</code></li>
<li><code>ContextDecorator</code></li>
<li><code>ExitStack</code></li>
</ul>
<h3 id="使用-contextmanager"><a href="#使用-contextmanager" class="headerlink" title="使用@contextmanager"></a>使用@contextmanager</h3><p><code>@contextmanager</code>装饰器能减少创建上下文管理器的样板代码量，因为不用编写一个完整的类，定义<code>__enter__</code>和<code>__exit__</code>方法，而只需实现有一个<code>yield</code>语句的生成器，生成想让<code>__enter__</code>方法返回的值。</p>
<p>在使用<code>@contextmanager</code>装饰的生成器中，<code>yield</code>语句的作用是把函数的定义体分成两部分：<code>yield</code>语句前面的所有代码在<code>with</code>块开始时执行即调用<code>__enter__</code>方法，<code>yield</code>语句后面的代码在<code>with</code>块结束时执行即调用<code>__exit__</code>方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> contextlib</div><div class="line"></div><div class="line"><span class="meta">@contextlib.contextmanager  </span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">looking_glass</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">import</span> sys</div><div class="line">    original_write = sys.stdout.write  </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverse_write</span><span class="params">(text)</span>:</span>  </div><div class="line">        original_write(text[::<span class="number">-1</span>])</div><div class="line"></div><div class="line">    sys.stdout.write = reverse_write  </div><div class="line">    msg = <span class="string">''</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">    	<span class="keyword">yield</span> <span class="string">'JABBERWOCKY'</span>  <span class="comment"># &lt;1&gt;</span></div><div class="line">    <span class="keyword">except</span> ZeroDivisionError:  <span class="comment"># &lt;2&gt;</span></div><div class="line">        msg = <span class="string">'Please DO NOT divide by zero!'</span></div><div class="line">    <span class="keyword">finally</span>:				  <span class="comment"># &lt;3&gt;</span></div><div class="line">    	sys.stdout.write = original_write  <span class="comment"># &lt;4&gt;</span></div><div class="line">    	<span class="keyword">if</span> msg:</div><div class="line">            print(msg)</div><div class="line">            </div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">with</span> looking_glass() <span class="keyword">as</span> what:</div><div class="line"><span class="meta">... </span>	print(<span class="string">'hehe'</span>)</div><div class="line"><span class="meta">... </span>	print(what)</div></pre></td></tr></table></figure>
<ol>
<li>产出一个值，这个值会绑定到<code>with</code>语句中<code>as</code>子句的目标变量上，执行<code>with</code>块中的代码时，这个函数会在这一点暂停</li>
<li>捕获<code>ZeroDivisionError</code>异常</li>
<li>如果出现异常，<code>looking_glass</code>函数将会终止，将无法恢复原来的<code>sys.stout.write</code>方法，导致系统处于无效状态。因此要使用<code>try...except...finally</code>语句定义最终状态</li>
<li>控制权一旦跳出<code>with</code>块，继续执行<code>yield</code>语句之后的代码：这里是恢复成原来的<code>sys.stout.write</code>方法</li>
</ol>
<h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h2><h3 id="生成器如何进化成协程"><a href="#生成器如何进化成协程" class="headerlink" title="生成器如何进化成协程"></a>生成器如何进化成协程</h3><ul>
<li>生成器的调用方可以使用<code>.send()</code>方法发送数据，发送的数据会成为生成器函数中<code>yield</code>表达式的值</li>
<li>生成器可以作为协程使用，协程是指一个过程，这个过程与调用方协作，产出由调用方提供的值</li>
</ul>
<h3 id="用作协程的生成器的基本行为"><a href="#用作协程的生成器的基本行为" class="headerlink" title="用作协程的生成器的基本行为"></a>用作协程的生成器的基本行为</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">simple_coroutine</span><span class="params">()</span>:</span> <span class="comment"># 1</span></div><div class="line">    ... print(<span class="string">'-&gt; coroutine started'</span>)</div><div class="line">    ... x = <span class="keyword">yield</span> <span class="comment"># 2</span></div><div class="line">    ... print(<span class="string">'-&gt; coroutine received:'</span>, x)</div><div class="line">    ...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>my_coro = simple_coroutine()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>my_coro </div><div class="line">&lt;generator object simple_coroutine at <span class="number">0x100c2be10</span></div><div class="line">&gt;&gt;&gt;&gt; next(my_coro) <span class="comment"># 3</span></div><div class="line">-&gt; coroutine started</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>my_coro.send(<span class="number">42</span>) <span class="comment"># 4</span></div><div class="line">-&gt; coroutine received: 42</div><div class="line">Traceback (most recent call last): <span class="comment"># 5</span></div><div class="line">    ...</div><div class="line">StopIteration</div></pre></td></tr></table></figure>
<ol>
<li>协程使用生成器函数定义：定义体中有<code>yield</code>关键字</li>
<li><code>yield</code>在表达式中使用；如果协程只需从客户那里接受数据，那么产出的值是<code>None</code>，这个值是隐式指定的，因为<code>yield</code>关键字右边没有表达式</li>
<li>首先要调用<code>next()</code>函数，因为生成器还没启动，没在<code>yield</code>语句处暂停，所以一开始无法发送数据，最先调用<code>next()</code>函数通常称为<strong>预激协程</strong></li>
<li>调用<code>send()</code>方法，协程定义体中的<code>yield</code>表达式会计算出42；现在协程会恢复，一直运行到下一个<code>yield</code>表达式或者终止</li>
<li>控制权流动到协程定义体的末尾，导致生产器像往常一样抛出<code>StopIteration</code>异常</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">simple_coro2</span><span class="params">(a)</span>:</span></div><div class="line">    ... print(<span class="string">'-&gt; Started: a ='</span>, a)</div><div class="line">    ... b = <span class="keyword">yield</span> a</div><div class="line">    ... print(<span class="string">'-&gt; Received: b ='</span>, b)</div><div class="line">    ... c = <span class="keyword">yield</span> a + b</div><div class="line">    ... print(<span class="string">'-&gt; Received: c ='</span>, c)</div><div class="line">    ...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>my_coro2 = simple_coro2(<span class="number">14</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> inspect <span class="keyword">import</span> getgeneratorstate</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>getgeneratorstate(my_coro2)  <span class="comment"># 1</span></div><div class="line"><span class="string">'GEN_CREATED'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(my_coro2) </div><div class="line">-&gt; Started: a = 14</div><div class="line"><span class="number">14</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>getgeneratorstate(my_coro2)  <span class="comment"># 2</span></div><div class="line"><span class="string">'GEN_SUSPENDED'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>my_coro2.send(<span class="number">28</span>)  <span class="comment"># 3</span></div><div class="line">-&gt; Received: b = 28</div><div class="line"><span class="number">42</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>my_coro2.send(<span class="number">99</span>)  </div><div class="line">-&gt; Received: c = 99</div><div class="line">Traceback (most recent call last):</div><div class="line">	File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">StopIteration</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>getgeneratorstate(my_coro2)  <span class="comment"># 4</span></div><div class="line"><span class="string">'GEN_CLOSE</span></div></pre></td></tr></table></figure>
<ol>
<li><code>inspect.getgeneratorstate</code>函数表明，处于<code>GEN_CREATED</code>状态，即协程未启动</li>
<li><code>inspect.getgeneratorstate</code>函数表明，处于<code>GEN_SUSPENDED</code>状态，即协程在<code>yield</code>表达式处暂停</li>
<li>把数字28发给暂停的协程：计算<code>yield</code>表达式，得到28，再把这个数绑定给<code>b</code>。产出<code>a+b</code>的值，然后协程暂停，等待为<code>c</code>赋值</li>
<li><code>inspect.getgeneratorstate</code>函数表明，处于<code>GEN_CLOSED</code>状态，即协程执行结束</li>
</ol>
<h3 id="使用协程计算移动平均值"><a href="#使用协程计算移动平均值" class="headerlink" title="使用协程计算移动平均值"></a>使用协程计算移动平均值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">averager</span><span class="params">()</span>:</span></div><div class="line">    total = <span class="number">0.0</span></div><div class="line">    count = <span class="number">0</span></div><div class="line">    average = <span class="keyword">None</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:  <span class="comment"># &lt;1&gt;</span></div><div class="line">        term = <span class="keyword">yield</span> average  <span class="comment"># &lt;2&gt;</span></div><div class="line">        total += term</div><div class="line">        count += <span class="number">1</span></div><div class="line">        average = total/count</div></pre></td></tr></table></figure>
<ol>
<li>这个无限循环表明，只要调用方不断把值发给这个协程，它就会一直收值，然后生成结果。仅当调用方在协程上调用<code>.close()</code>方法，或者没有对协程的引用而被垃圾回收程序回收时，这个协程才会终止</li>
<li>这里的<code>yield</code>表达式用于暂停执行协程，把结果发给调用方：还用于接受调用方后面发给协程的值，恢复无限循环</li>
<li>使用协程的好处是，<code>total</code>和<code>count</code>不必声明为全局变量，无需使用实例属性或闭包在多次调用之间保持上下文</li>
</ol>
<h3 id="预激协程的装饰器"><a href="#预激协程的装饰器" class="headerlink" title="预激协程的装饰器"></a>预激协程的装饰器</h3><p>如果不预激，那么协程也就没什么用。为了简化协程的用法，有时会使用一个预激装饰器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">coroutine</span><span class="params">(func)</span>:</span></div><div class="line">    <span class="string">"""Decorator: primes `func` by advancing to first `yield`"""</span></div><div class="line"><span class="meta">    @wraps(func)</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">primer</span><span class="params">(*args,**kwargs)</span>:</span>  <span class="comment"># &lt;1&gt;</span></div><div class="line">        gen = func(*args,**kwargs)  <span class="comment"># &lt;2&gt;</span></div><div class="line">        next(gen)  <span class="comment"># &lt;3&gt;</span></div><div class="line">        <span class="keyword">return</span> gen  <span class="comment"># &lt;4&gt;</span></div><div class="line">    <span class="keyword">return</span> primer</div><div class="line">    </div><div class="line"><span class="meta">@coroutine  # &lt;5&gt;</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">averager</span><span class="params">()</span>:</span>  <span class="comment"># &lt;6&gt;</span></div><div class="line">    total = <span class="number">0.0</span></div><div class="line">    count = <span class="number">0</span></div><div class="line">    average = <span class="keyword">None</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        term = <span class="keyword">yield</span> average</div><div class="line">        total += term</div><div class="line">        count += <span class="number">1</span></div><div class="line">        average = total/count</div></pre></td></tr></table></figure>
<ol>
<li>把被装饰的生成器函数替换成这里的<code>primer</code>函数；调用<code>primer</code>函数时，返回预激后的生成器。</li>
<li>预激生成器，返回生成器</li>
<li>把装饰器应用到<code>averager</code>函数上</li>
</ol>
<h3 id="终止协程和异常处理"><a href="#终止协程和异常处理" class="headerlink" title="终止协程和异常处理"></a>终止协程和异常处理</h3><p>未处理的异常会导致协程终止。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoException</span><span class="params">(Exception)</span>:</span></div><div class="line">    <span class="string">"""An exception type for the demonstration."""</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">demo_exc_handling</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'-&gt; coroutine started'</span>)</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            x = <span class="keyword">yield</span></div><div class="line">        <span class="keyword">except</span> DemoException:  <span class="comment"># &lt;1&gt;</span></div><div class="line">            print(<span class="string">'*** DemoException handled. Continuing...'</span>)</div><div class="line">        <span class="keyword">else</span>:  </div><div class="line">            print(<span class="string">'-&gt; coroutine received: &#123;!r&#125;'</span>.format(x))</div><div class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">'This line should never run.'</span>)  </div><div class="line">    </div><div class="line"><span class="comment"># 激活</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> inspect <span class="keyword">import</span> getgeneratorstate</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>exc_coro = demo_exc_handling()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(exc_coro)</div><div class="line">-&gt; coroutine started</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>exc_coro.send(<span class="number">11</span>)</div><div class="line">-&gt; coroutine received: 11</div><div class="line">    </div><div class="line"><span class="comment"># 如果关闭</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>exc_coro.close()  <span class="comment"># 2</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>getgeneratorstate(exc_coro)</div><div class="line"><span class="string">'GEN_CLOSED'</span></div><div class="line"></div><div class="line"><span class="comment"># 如果传入异常</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>exc_coro.throw(DemoException)  <span class="comment"># 3</span></div><div class="line">*** DemoException handled. Continuing...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>getgeneratorstate(exc_coro)</div><div class="line"><span class="string">'GEN_SUSPENDED'</span></div></pre></td></tr></table></figure>
<ol>
<li>特别处理<code>DemoException</code>异常</li>
<li><code>.close()</code>方法致使生成器在暂停的<code>yield</code>表达式抛出<code>GeneratorExit</code>异常。如果生成器没有处理这个异常，或者抛出<code>StopIteration</code>异常，调用方也不会报错</li>
<li><code>.throw</code>方法可以使生成器在暂停的<code>yield</code>表达式抛出指定异常，不会导致协程终止</li>
</ol>
<h3 id="让协程返回值"><a href="#让协程返回值" class="headerlink" title="让协程返回值"></a>让协程返回值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</div><div class="line"></div><div class="line">Result = namedtuple(<span class="string">'Result'</span>, <span class="string">'count average'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">averager</span><span class="params">()</span>:</span></div><div class="line">    total = <span class="number">0.0</span></div><div class="line">    count = <span class="number">0</span></div><div class="line">    average = <span class="keyword">None</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        term = <span class="keyword">yield</span></div><div class="line">        <span class="keyword">if</span> term <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            <span class="keyword">break</span>  <span class="comment"># &lt;1&gt;</span></div><div class="line">        total += term</div><div class="line">        count += <span class="number">1</span></div><div class="line">        average = total/count</div><div class="line">    <span class="keyword">return</span> Result(count, average)  <span class="comment"># &lt;2&gt;</span></div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>coro_avg = averager()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(coro_avg)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>coro_avg.send(<span class="number">10</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>coro_avg.send(<span class="number">30</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>coro_avg.send(<span class="number">6.5</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">try</span>:</div><div class="line">    ... coro_avg.send(<span class="keyword">None</span>)</div><div class="line">    ... <span class="keyword">except</span> StopIteration <span class="keyword">as</span> exc:  <span class="comment"># 3</span></div><div class="line">        ... result = exc.value</div><div class="line">        </div><div class="line"><span class="meta">&gt;&gt;&gt; </span>resultResult(count=<span class="number">3</span>, average=<span class="number">15.5</span>)</div></pre></td></tr></table></figure>
<ol>
<li>为了返回值，协程必须正常终止</li>
<li>返回一个<code>nametuple</code>，包含<code>count</code>和<code>average</code>两个字段</li>
<li>捕获<code>StopIteration</code>异常，获取<code>averager</code>返回的值</li>
</ol>
<h3 id="使用yield-from"><a href="#使用yield-from" class="headerlink" title="使用yield from"></a>使用yield from</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</div><div class="line"></div><div class="line">Result = namedtuple(<span class="string">'Result'</span>, <span class="string">'count average'</span>)</div><div class="line"></div><div class="line"><span class="comment"># the subgenerator</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">averager</span><span class="params">()</span>:</span>  <span class="comment"># &lt;1&gt;</span></div><div class="line">    total = <span class="number">0.0</span></div><div class="line">    count = <span class="number">0</span></div><div class="line">    average = <span class="keyword">None</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        term = <span class="keyword">yield</span>  <span class="comment">#</span></div><div class="line">        <span class="keyword">if</span> term <span class="keyword">is</span> <span class="keyword">None</span>:  <span class="comment"># &lt;3&gt;</span></div><div class="line">            <span class="keyword">break</span></div><div class="line">        total += term</div><div class="line">        count += <span class="number">1</span></div><div class="line">        average = total/count</div><div class="line">    <span class="keyword">return</span> Result(count, average)  <span class="comment"># &lt;4&gt;</span></div><div class="line"></div><div class="line"><span class="comment"># the delegating generator</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">grouper</span><span class="params">(results, key)</span>:</span>  <span class="comment"># &lt;5&gt;</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:  <span class="comment"># &lt;6&gt;</span></div><div class="line">        results[key] = <span class="keyword">yield</span> <span class="keyword">from</span> averager()  <span class="comment"># &lt;7&gt;</span></div><div class="line"></div><div class="line"><span class="comment"># the client code, a.k.a. the caller</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(data)</span>:</span>  <span class="comment"># &lt;8&gt;</span></div><div class="line">    results = &#123;&#125;</div><div class="line">    <span class="keyword">for</span> key, values <span class="keyword">in</span> data.items():</div><div class="line">        group = grouper(results, key)  <span class="comment"># &lt;9&gt;</span></div><div class="line">        next(group)  <span class="comment"># &lt;10&gt;</span></div><div class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> values:</div><div class="line">            group.send(value)  <span class="comment"># &lt;11&gt;</span></div><div class="line">        group.send(<span class="keyword">None</span>)  <span class="comment"># important! &lt;12&gt;</span></div><div class="line"></div><div class="line">    <span class="comment"># print(results)  # uncomment to debug</span></div><div class="line">    report(results)</div><div class="line"></div><div class="line"><span class="comment"># output report</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">report</span><span class="params">(results)</span>:</span></div><div class="line">    <span class="keyword">for</span> key, result <span class="keyword">in</span> sorted(results.items()):</div><div class="line">        group, unit = key.split(<span class="string">';'</span>)</div><div class="line">        print(<span class="string">'&#123;:2&#125; &#123;:5&#125; averaging &#123;:.2f&#125;&#123;&#125;'</span>.format(</div><div class="line">              result.count, group, result.average, unit))</div><div class="line"></div><div class="line">data = &#123;</div><div class="line">    <span class="string">'girls;kg'</span>:</div><div class="line">        [<span class="number">40.9</span>, <span class="number">38.5</span>, <span class="number">44.3</span>, <span class="number">42.2</span>, <span class="number">45.2</span>, <span class="number">41.7</span>, <span class="number">44.5</span>, <span class="number">38.0</span>, <span class="number">40.6</span>, <span class="number">44.5</span>],</div><div class="line">    <span class="string">'girls;m'</span>:</div><div class="line">        [<span class="number">1.6</span>, <span class="number">1.51</span>, <span class="number">1.4</span>, <span class="number">1.3</span>, <span class="number">1.41</span>, <span class="number">1.39</span>, <span class="number">1.33</span>, <span class="number">1.46</span>, <span class="number">1.45</span>, <span class="number">1.43</span>],</div><div class="line">    <span class="string">'boys;kg'</span>:</div><div class="line">        [<span class="number">39.0</span>, <span class="number">40.8</span>, <span class="number">43.2</span>, <span class="number">40.8</span>, <span class="number">43.1</span>, <span class="number">38.6</span>, <span class="number">41.4</span>, <span class="number">40.6</span>, <span class="number">36.3</span>],</div><div class="line">    <span class="string">'boys;m'</span>:</div><div class="line">        [<span class="number">1.38</span>, <span class="number">1.5</span>, <span class="number">1.32</span>, <span class="number">1.25</span>, <span class="number">1.37</span>, <span class="number">1.48</span>, <span class="number">1.25</span>, <span class="number">1.49</span>, <span class="number">1.46</span>],</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main(data)</div></pre></td></tr></table></figure>
<ol>
<li><code>averager</code>是<strong>子生成器</strong></li>
<li><code>main</code>函数中的客户代码发送的各个值绑定到这里的<code>term</code>变量上</li>
<li>至关重要的终止条件，如果没有终止条件，使用<code>yield from</code>调用这个协程的生成器会永远阻塞</li>
<li>返回的<code>Result</code>会成为<code>grouper</code>函数中<code>yield from</code>表达式的值</li>
<li><code>grouper</code>是<strong>委派生成器</strong></li>
<li>这个循环每次迭代时会新建一个<code>averager</code>实例，每个实例都是作为协程使用的生成器对象</li>
<li><code>grouper</code>发送的每个值都会经由<code>yield from</code>处理，通过管道传给<code>averager</code>实例。<code>grouper</code>会在<code>yield from</code>表达式处暂停，等待<code>averager</code>实例处理客户端发来的值。<code>averager</code>实例运行完毕后，返回的值绑定到<code>result[key]</code>上。<code>while</code>循环会不断创建<code>averager</code>实例，处理更多的值</li>
<li><code>main</code>函数是客户端代码，即是<strong>调用方</strong></li>
<li><code>group</code>是调用<code>grouper</code>函数得到的生成器对象，传给<code>grouper</code>函数的第一个参数是<code>results</code>，用于收集结果，第二个参数是某键。<code>group</code>作为协程使用。</li>
<li>预激<code>group</code>协程</li>
<li>把各个<code>value</code>传给<code>grouper</code>。传入的值最终到达<code>averager</code>函数中<code>term = yield</code>那一行</li>
<li>把<code>None</code>传入<code>grouper</code>，导致当前的<code>averager</code>实例终止，也让<code>grouper</code>继续运行，再创建一个<code>averager</code>实例，处理下一组值</li>
</ol>
<h3 id="yield-from的意义"><a href="#yield-from的意义" class="headerlink" title="yield from的意义"></a>yield from的意义</h3><p><code>yield from</code>的主要功能是打开双向通道，把最外层的调用方与最内层的子生成器连接起来，这样二者可以直接发送和产出值，还可以直接传入异常，而不用在位于中间的协程中添加大量处理异常的样板代码以及各种<code>.close()</code>和<code>.throw()</code>方法。</p>
<h2 id="使用future处理并发"><a href="#使用future处理并发" class="headerlink" title="使用future处理并发"></a>使用future处理并发</h2><blockquote>
<ul>
<li><strong>并发</strong>：交替做不同事的能力</li>
<li><strong>并行</strong>：同时做不同事的能力</li>
</ul>
</blockquote>
<h3 id="网络下载的三种风格"><a href="#网络下载的三种风格" class="headerlink" title="网络下载的三种风格"></a>网络下载的三种风格</h3><p><strong>CPU密集型任务</strong>  vs <strong>IO密集型任务</strong></p>
<p>为了高效处理网络IO，需要使用并发，因为网络有很高的延迟，所以为了不浪费CPU周期去等待，最好在收到网络响应之前做些其他的事。</p>
<h4 id="使用依序下载"><a href="#使用依序下载" class="headerlink" title="使用依序下载"></a>使用依序下载</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> requests  <span class="comment"># &lt;1&gt;</span></div><div class="line"></div><div class="line">POP20_CC = (<span class="string">'CN IN US ID BR PK NG BD RU JP '</span></div><div class="line">            <span class="string">'MX PH VN ET EG DE IR TR CD FR'</span>).split()  <span class="comment"># &lt;2&gt;</span></div><div class="line">BASE_URL = <span class="string">'http://flupy.org/data/flags'</span>  <span class="comment"># &lt;3&gt;</span></div><div class="line">DEST_DIR = <span class="string">'downloads/'</span>  <span class="comment"># &lt;4&gt;</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_flag</span><span class="params">(img, filename)</span>:</span>  <span class="comment"># &lt;5&gt;</span></div><div class="line">    path = os.path.join(DEST_DIR, filename)</div><div class="line">    <span class="keyword">with</span> open(path, <span class="string">'wb'</span>) <span class="keyword">as</span> fp:</div><div class="line">        fp.write(img)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span><span class="params">(cc)</span>:</span>  <span class="comment"># &lt;6&gt;</span></div><div class="line">    url = <span class="string">'&#123;&#125;/&#123;cc&#125;/&#123;cc&#125;.gif'</span>.format(BASE_URL, cc=cc.lower())</div><div class="line">    resp = requests.get(url)</div><div class="line">    <span class="keyword">return</span> resp.content</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(text)</span>:</span>  <span class="comment"># &lt;7&gt;</span></div><div class="line">    print(text, end=<span class="string">' '</span>)</div><div class="line">    sys.stdout.flush()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_many</span><span class="params">(cc_list)</span>:</span>  <span class="comment"># &lt;8&gt;</span></div><div class="line">    <span class="keyword">for</span> cc <span class="keyword">in</span> sorted(cc_list):  <span class="comment"># &lt;9&gt;</span></div><div class="line">        image = get_flag(cc)</div><div class="line">        show(cc)</div><div class="line">        save_flag(image, cc.lower() + <span class="string">'.gif'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> len(cc_list)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(download_many)</span>:</span>  <span class="comment"># &lt;10&gt;</span></div><div class="line">    t0 = time.time()</div><div class="line">    count = download_many(POP20_CC)</div><div class="line">    elapsed = time.time() - t0</div><div class="line">    msg = <span class="string">'\n&#123;&#125; flags downloaded in &#123;:.2f&#125;s'</span></div><div class="line">    print(msg.format(count, elapsed))</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main(download_many)  <span class="comment"># &lt;11&gt;</span></div></pre></td></tr></table></figure>
<h4 id="使用concurrent-futures模块下载"><a href="#使用concurrent-futures模块下载" class="headerlink" title="使用concurrent.futures模块下载"></a>使用<code>concurrent.futures</code>模块下载</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</div><div class="line"><span class="keyword">from</span> flags <span class="keyword">import</span> save_flag, get_flag, show, main  </div><div class="line"></div><div class="line">MAX_WORKERS = <span class="number">20</span>  <span class="comment"># 1</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_one</span><span class="params">(cc)</span>:</span>  </div><div class="line">    image = get_flag(cc)</div><div class="line">    show(cc)</div><div class="line">    save_flag(image, cc.lower() + <span class="string">'.gif'</span>)</div><div class="line">    <span class="keyword">return</span> cc</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_many</span><span class="params">(cc_list)</span>:</span></div><div class="line">    workers = min(MAX_WORKERS, len(cc_list))  <span class="comment"># 2</span></div><div class="line">    <span class="keyword">with</span> futures.ThreadPoolExecutor(workers) <span class="keyword">as</span> executor:  <span class="comment"># 3</span></div><div class="line">        res = executor.map(download_one, sorted(cc_list))  <span class="comment"># 4</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> len(list(res))  <span class="comment"># 5</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main(download_many)</div></pre></td></tr></table></figure>
<ol>
<li>设定<code>ThreadPoolEXecutor</code>类最多使用几个线程</li>
<li>设定工作的线程数量，使用允许的最大值<code>MAX_WORKERS</code>与要处理的数量之间较小的那个值，以免创建多余的线程</li>
<li>使用工作的线程数实例化<code>ThreadPoolExecutor</code>，<code>executor.__exit__</code>方法会用<code>executor.shutdown(wait=True)</code>方法，它会在所有线程都执行完毕钱阻塞线程</li>
<li><code>map</code>方法的作用与内置的<code>map</code>函数类似，不过<code>download_one</code>函数会在多个线程中并发调用；<code>map</code>方法返回一个生成器，因此可以迭代，获取各个返回的值</li>
</ol>
<h4 id="Future在哪里"><a href="#Future在哪里" class="headerlink" title="Future在哪里"></a><code>Future</code>在哪里</h4><p><code>Future</code>类的实例表示：可能已经完成或者尚未完成的延迟计算。它封装待完成的操作，可以放入队列，完成的状态可以查询，得到记过后可以获取结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_many</span><span class="params">(cc_list)</span>:</span></div><div class="line">    cc_list = cc_list[:<span class="number">5</span>]  </div><div class="line">    <span class="keyword">with</span> futures.ThreadPoolExecutor(max_workers=<span class="number">3</span>) <span class="keyword">as</span> executor:  </div><div class="line">        to_do = []</div><div class="line">        <span class="keyword">for</span> cc <span class="keyword">in</span> sorted(cc_list):  </div><div class="line">            future = executor.submit(download_one, cc)  <span class="comment"># 1</span></div><div class="line">            to_do.append(future)  <span class="comment"># 2</span></div><div class="line">            msg = <span class="string">'Scheduled for &#123;&#125;: &#123;&#125;'</span></div><div class="line">            print(msg.format(cc, future))  </div><div class="line"></div><div class="line">        results = []</div><div class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> futures.as_completed(to_do):  <span class="comment"># 3</span></div><div class="line">            res = future.result()  <span class="comment"># 4</span></div><div class="line">            msg = <span class="string">'&#123;&#125; result: &#123;!r&#125;'</span></div><div class="line">            print(msg.format(future, res)) </div><div class="line">            results.append(res)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> len(results)</div></pre></td></tr></table></figure>
<ol>
<li><code>executor.submit</code>方法排定可调用对象的执行时间，然后返回一个<code>Future</code>，表示这个待执行操作</li>
<li>存储各个<code>Future</code>，后面传递个<code>as_completed</code>函数</li>
<li><code>as_completed</code>函数在<code>Future</code>运行结束后产出<code>Future</code></li>
<li>获取该<code>Futrue</code>的结果</li>
</ol>
<h3 id="阻塞型IO和GIL"><a href="#阻塞型IO和GIL" class="headerlink" title="阻塞型IO和GIL"></a>阻塞型IO和GIL</h3><p>CPython解释器不是线程安全的，因此有<strong>全程解释器锁</strong><code>GIL</code>，一次只允许使用一个线程执行Python字节码。</p>
<p>标准库中所有执行<strong>阻塞型IO操作的函数</strong>，在等待操作系统返回结果时都会释放<code>GIL</code>。这意味着在Python语言层次可以使用多线程，而IO密集型Python程序能从中受益：一个Python线程等待网络响应时，阻塞型IO函数会释放<code>GIL</code>，再运行一个线程。</p>
<h3 id="使用concurrent-futures模块启动进程"><a href="#使用concurrent-futures模块启动进程" class="headerlink" title="使用concurrent.futures模块启动进程"></a>使用concurrent.futures模块启动进程</h3><p><code>concurrent.futures</code>这个模块实现的是真正的并行计算，因为它使用<code>ProcessPoolExecutor</code>类把工作分配给多个Python进程处理，因此如果需要做<strong>CPU密集处理</strong>，使用这个模块能够绕开<code>GIL</code>，利用所有可用的CPU核心。</p>
<h3 id="实验Executor-map方法"><a href="#实验Executor-map方法" class="headerlink" title="实验Executor.map方法"></a>实验Executor.map方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep, strftime</div><div class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">display</span><span class="params">(*args)</span>:</span>  </div><div class="line">    print(strftime(<span class="string">'[%H:%M:%S]'</span>), end=<span class="string">' '</span>)</div><div class="line">    print(*args)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">loiter</span><span class="params">(n)</span>:</span>  </div><div class="line">    msg = <span class="string">'&#123;&#125;loiter(&#123;&#125;): doing nothing for &#123;&#125;s...'</span></div><div class="line">    display(msg.format(<span class="string">'\t'</span>*n, n, n))</div><div class="line">    sleep(n)</div><div class="line">    msg = <span class="string">'&#123;&#125;loiter(&#123;&#125;): done.'</span></div><div class="line">    display(msg.format(<span class="string">'\t'</span>*n, n))</div><div class="line">    <span class="keyword">return</span> n * <span class="number">10</span>  </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    display(<span class="string">'Script starting.'</span>)</div><div class="line">    executor = futures.ThreadPoolExecutor(max_workers=<span class="number">3</span>)  <span class="comment"># 1</span></div><div class="line">    results = executor.map(loiter, range(<span class="number">5</span>))  <span class="comment"># 2</span></div><div class="line">    display(<span class="string">'results:'</span>, results)  </div><div class="line">    display(<span class="string">'Waiting for individual results:'</span>)</div><div class="line">    <span class="keyword">for</span> i, result <span class="keyword">in</span> enumerate(results):  <span class="comment"># 3</span></div><div class="line">        display(<span class="string">'result &#123;&#125;: &#123;&#125;'</span>.format(i, result))</div><div class="line"></div><div class="line">main()</div></pre></td></tr></table></figure>
<ol>
<li>创建<code>ThreadPoolExecutor</code>实例，有3个线程</li>
<li>把五个任务提交给<code>executor</code>，因为只有3个线程，所以只有3个任务会立即开始：<code>loiter(0)</code>、<code>loiter(1)</code>和<code>loiter(2)</code>，这是非阻塞调用</li>
<li><code>for</code>循环中的<code>enumerate</code>函数会隐式调用<code>next(results)</code>，这个函数又会在内部表示第一个任务<code>loiter(0)</code>的<code>_f</code>期物上调用<code>_f.result()</code>方法。<code>result</code>方法会阻塞，直到期物运行结束，因此这个循环每次迭代时都要等待下一个结果做好准备。</li>
</ol>
<h3 id="线程和多进程的替代方案"><a href="#线程和多进程的替代方案" class="headerlink" title="线程和多进程的替代方案"></a>线程和多进程的替代方案</h3><ul>
<li><code>futures.ThreadPoolExecutor</code>类可以创建多线程，但是不够灵活可能要使用<code>threading</code>模块来自行制定方案，比如说使用<code>queue</code>模块创建线程安全的队列，在线程之间传递数据</li>
<li><code>futures.ProcessPoolExecutor</code>类可以创建多进程，但是不够灵活可能要使用<code>multiprocessing</code>模块代来自行定制方案，可以解决协作进程之间传递数据的问题</li>
</ul>
<h2 id="使用asyncio包处理并发"><a href="#使用asyncio包处理并发" class="headerlink" title="使用asyncio包处理并发"></a>使用asyncio包处理并发</h2><blockquote>
<ul>
<li><strong>阻塞与非阻塞</strong>：如果不能立即获得结果，那么是否等待？</li>
<li><strong>同步与异步</strong>：是否需要调用者来通知结果</li>
</ul>
<p>如何解决<strong>CPU高速执行能力</strong>和<strong>IO设备低速执行能力</strong>之间的矛盾？</p>
<ul>
<li><p><strong>同步IO</strong>：等待IO操作完成，才能进行下一步操作</p>
<p>同步IO模型下，主线程只能被挂起。使用多线程和多进程方法解决同步IO的并发问题，但是系统不能无上限的增加线程。由于系统切换线程的开销也很大，所以一旦线程数量过多，CPU的时间就话在线程切换上了，真正运行代码的时间就少了，结果导致性能下降。</p>
</li>
<li><p><strong>异步IO</strong>：不等待IO结果，去干别的事。当IO返回结果时再通知CPU处理。</p>
<p>异步模型下，主线程并没有休息，而是在消息循环中继续处理其他消息。这样，一个线程就可以同时处理多个IO请求，并且没有切换线程的操作。对于大多数IO密集型的应用程序，异步IO将大大提升系统的多任务处理能力。</p>
</li>
</ul>
</blockquote>
<h3 id="线程与协程对比"><a href="#线程与协程对比" class="headerlink" title="线程与协程对比"></a>线程与协程对比</h3><blockquote>
<ul>
<li><p><strong>进程</strong>：一个程序在一个数据集中的一次动态执行过程，它是操作系统进行资源分配和调度的一个独立单位。</p>
<p>进程一般由程序、数据集、进程控制块三部分组成。我么编写的程序用来描述进程要完成哪些功能以及如何完成；数据集则是程序在执行过程中所需要使用的资源；进程控制块用来记录进程的外部特征，描述进程的执行变化过程，系统可以利用它来控制和管理进程，它是系统感知进程存在的唯一标志。</p>
<p>进程占据独立内存，不同进程通过进程间通信来通信。创建、撤销和切换的开销比较大，但是相对稳定安全。</p>
</li>
<li><p><strong>线程</strong>：进程的一个实体，是操作系统调度和分派的基本单位，它是比进程更小的能独立运行的基本单位。</p>
<p>线程自己不拥有系统资源，只拥有一点在运行中必不可少的资源，如程序计数器、一组寄存器和栈，但是它可与同属一个进程的其他的线程共享进程所拥有的全部资源。</p>
<p>线程间通信主要通过共享内存，上下文切换很快，资源开销较少，但相比进程不够稳定容易丢失数据。</p>
</li>
<li><p><strong>协程</strong>：一种用户态的轻量级线程，它的调度完全由用户在代码里控制，不关操作系统什么事。</p>
<p>协程的执行效率非常高。因为子程序切换不是线程切换而由程序自身控制。因此没有线程切换的开销，和多线程比，线程数量越多协程性能就越明显。协程不需要多线程的锁机制。在协程中控制共享资源不加锁，只需要判断状态就好了。</p>
</li>
</ul>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> itertools</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">spin</span><span class="params">(msg, done)</span>:</span>  </div><div class="line">    write, flush = sys.stdout.write, sys.stdout.flush</div><div class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> itertools.cycle(<span class="string">'|/-\\'</span>):  <span class="comment"># 1</span></div><div class="line">        status = char + <span class="string">' '</span> + msg</div><div class="line">        write(status)</div><div class="line">        flush()</div><div class="line">        write(<span class="string">'\x08'</span> * len(status))  <span class="comment"># 2</span></div><div class="line">        <span class="keyword">if</span> done.wait(<span class="number">.1</span>):  </div><div class="line">            <span class="keyword">break</span></div><div class="line">    write(<span class="string">' '</span> * len(status) + <span class="string">'\x08'</span> * len(status))  </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">slow_function</span><span class="params">()</span>:</span>  </div><div class="line">    <span class="comment"># pretend waiting a long time for I/O</span></div><div class="line">    time.sleep(<span class="number">3</span>)  </div><div class="line">    <span class="keyword">return</span> <span class="number">42</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">supervisor</span><span class="params">()</span>:</span>  <span class="comment"># 3</span></div><div class="line">    done = threading.Event()  <span class="comment"># 4</span></div><div class="line">    spinner = threading.Thread(target=spin,</div><div class="line">                               args=(<span class="string">'thinking!'</span>, done))</div><div class="line">    print(<span class="string">'spinner object:'</span>, spinner)  </div><div class="line">    spinner.start()  <span class="comment"># 5</span></div><div class="line">    result = slow_function()  <span class="comment"># 6</span></div><div class="line">    done.set()  </div><div class="line">    spinner.join()  </div><div class="line">    <span class="keyword">return</span> result</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    result = supervisor()  </div><div class="line">    print(<span class="string">'Answer:'</span>, result)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<ol>
<li>这是个无限循环，因为<code>itertools.cycle</code>函数会从指定的序列中反复不断的生成元素</li>
<li>这是显示文本式样动画的诀窍所在，使用退格符<code>\x08</code>把光标移回来</li>
<li>这个函数设置从属线程，显示线程对象，运行耗时的计算，最后杀死线程</li>
<li>定义事件<code>done = threading.Event()</code>，阻塞事件线程<code>done.wait()</code>如果事件标志为<code>True</code>则不阻塞若有参数为阻塞时间，继续事件线程<code>done.set()</code>设置时间标志位<code>True</code>，结束事件线程<code>done.clear()</code>设置事件标志为<code>False</code></li>
<li><code>spinner.start()</code>启动从属线程，<code>spinner.join()</code>等待线程结束</li>
<li>运行<code>slow_function</code>函数，阻塞主线程，同时从属线程以动画形式显示旋转指针</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"><span class="keyword">import</span> itertools</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine  # &lt;1&gt;</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">spin</span><span class="params">(msg)</span>:</span>  </div><div class="line">    write, flush = sys.stdout.write, sys.stdout.flush</div><div class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> itertools.cycle(<span class="string">'|/-\\'</span>):</div><div class="line">        status = char + <span class="string">' '</span> + msg</div><div class="line">        write(status)</div><div class="line">        flush()</div><div class="line">        write(<span class="string">'\x08'</span> * len(status))</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">.1</span>)  <span class="comment"># &lt;2&gt;</span></div><div class="line">        <span class="keyword">except</span> asyncio.CancelledError:  <span class="comment"># &lt;3&gt;</span></div><div class="line">            <span class="keyword">break</span></div><div class="line">    write(<span class="string">' '</span> * len(status) + <span class="string">'\x08'</span> * len(status))</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">slow_function</span><span class="params">()</span>:</span>  <span class="comment"># &lt;4&gt;</span></div><div class="line">    <span class="comment"># pretend waiting a long time for I/O</span></div><div class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">3</span>)  </div><div class="line">    <span class="keyword">return</span> <span class="number">42</span></div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">supervisor</span><span class="params">()</span>:</span>  <span class="comment"># &lt;5&gt;</span></div><div class="line">    spinner = asyncio.<span class="keyword">async</span>(spin(<span class="string">'thinking!'</span>))  <span class="comment"># &lt;6&gt;</span></div><div class="line">    print(<span class="string">'spinner object:'</span>, spinner)  </div><div class="line">    result = <span class="keyword">yield</span> <span class="keyword">from</span> slow_function()  <span class="comment"># &lt;7&gt;</span></div><div class="line">    spinner.cancel()  <span class="comment"># &lt;8&gt;</span></div><div class="line">    <span class="keyword">return</span> result</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    loop = asyncio.get_event_loop()  <span class="comment"># &lt;9&gt;</span></div><div class="line">    result = loop.run_until_complete(supervisor())  <span class="comment"># &lt;10&gt;</span></div><div class="line">    loop.close()</div><div class="line">    print(<span class="string">'Answer:'</span>, result)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<ol>
<li>使用<code>@asyncio.coroutine</code>装饰器不是强制要求，但是强烈建议这么做，因为这样能在一众普通函数中把协程凸显出来，也有助于调试。如果还没从中产出值，协程就被垃圾回收了，那就可以发出警告。这个装饰器不会预激协程。</li>
<li>使用<code>yield from asyncio.sleep(.1)</code>代替<code>time.sleep(.1)</code>，这样的休眠不会阻塞事件循环</li>
<li>如果<code>spin</code>函数苏醒后抛出<code>asyncio.CancelledError</code>异常，其原因是发出了取消请求，因此退出了循环</li>
<li>现在<code>slow_function</code>函数是协程了，在用休眠假装进行IO操作时，使用<code>yield from</code>继续执行事件循环，<code>yield from asyncio.sleep(3)</code>表达式把控制权交给主循环，在休眠结束后恢复这个协程</li>
<li>现在<code>supervisor</code>函数也是协程了，因此可以使用<code>yield from</code>驱动<code>slow_function</code>函数</li>
<li><code>asyncio.async()</code>函数排定<code>spin</code>协程的运行时间，使用一个<code>Task</code>对象包装<code>spin</code>协程并立即返回</li>
<li>驱动<code>slow_function()</code>函数，结束后获取返回值的同时，事件循环继续运行，因为<code>slow_function</code>函数最后使用<code>yield from asynico.sleep(3)</code>表达式把控制权交回给主循环</li>
<li><code>Task</code>对象可以取消，取消后会在协程当前暂停的<code>yield</code>处抛出<code>asynico.CancelledError</code>异常。协程可以捕获这个异常，也可以延迟取消，甚至拒绝取消</li>
<li>获取事件循环的引用。所谓<strong>事件循环</strong>，程序开启一个无限的循环，程序员会把一些函数注册到事件循环上，当满足事件发生的时候，调用相应的协程函数。</li>
<li>驱动<code>supervisor</code>协程，让它运行完毕。这个协程的返回值是这次调用的返回值</li>
</ol>
<h4 id="asynico-Future：故意不阻塞"><a href="#asynico-Future：故意不阻塞" class="headerlink" title="asynico.Future：故意不阻塞"></a>asynico.Future：故意不阻塞</h4><ul>
<li><code>asynico.Future</code>类的<code>.result()</code>方法没有参数，不能指定超时时间。此外，如果调用<code>.result()</code>方法时期物还没运行完毕，那么<code>.result()</code>方法不会阻塞去等待结果，而是抛出<code>asyncio.InvalidStateError</code>异常</li>
<li>使用<code>yield from</code>处理期物，等待期物运行完毕这一步无需我们关心，而且不会阻塞事件循环，因为在<code>asyncio</code>包中，<code>yield from</code>的作用是把控制权还给事件循环</li>
<li>一般情况下，<code>asynico.Future</code>对象由<code>yield from</code>驱动，而不是靠调用<code>.done()</code>、<code>.add_done_callback()</code>和<code>.result()</code>方法驱动</li>
</ul>
<h4 id="从期物、任务和协程中产出"><a href="#从期物、任务和协程中产出" class="headerlink" title="从期物、任务和协程中产出"></a>从期物、任务和协程中产出</h4><p>在<code>asyncio</code>包中，期物和协程关系紧密，因为可以使用<code>yield from</code>从<code>asyncio.Future</code>对象中产出结果。通过如<code>res = yield from foo()</code>可以互换协程和期物。</p>
<p>为了执行这些操作，必须排定协程的运行时间，然后使用<code>asyncio.Task</code>对象包装协程。对协程来说，获取<code>Task</code>对象有两种方式：</p>
<ul>
<li><p><code>asynico.async(coro_or_future, *, loop=None)</code></p>
<p>这个函数统一了协程和期物，第一个参数可以是其中的任意一个。如果是协程，那么<code>async</code>函数会调用<code>loop.create_task()</code>方法创建<code>Task</code>对象。<code>loop=</code>关键字参数是可选的，用于传入事件循环。如果没有传入，那么<code>async</code>函数会通过调用<code>asyncio.get_event_loop()</code>函数获取循环对象。</p>
</li>
<li><p><code>BaseEventLoop.create_task(coro)</code></p>
<p>这个方法排定协程的执行时间，返回一个<code>asynico.Task</code>对象。</p>
</li>
</ul>
<h3 id="使用asyncio和aiohttp包下载"><a href="#使用asyncio和aiohttp包下载" class="headerlink" title="使用asyncio和aiohttp包下载"></a>使用<code>asyncio</code>和<code>aiohttp</code>包下载</h3><ul>
<li>编写的协程链条始终通过把最外层委派生成器传给<code>asynico</code>包中的某个函数，如<code>loop.run_until_complete()</code>驱动</li>
<li>编写的协程链条最终通过<code>yield from</code>把职责委托给<code>asyncio</code>包中的某个协程函数或协程方法，如<code>asyncio.sleep()</code>和<code>aiohttp.request()</code></li>
<li>概括起来就是：使用<code>asyncio</code>包时，我们编写的异步代码包含由<code>asynico</code>本身驱动的协程即委派生成器，而生成器最终把职责委托给<code>asyncio</code>包或第三方库中的协程。这种处理方式相当于架起了管道，让<code>asynico</code>事件循环驱动执行低层异步IO操作的库函数。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"><span class="keyword">import</span> aiohttp  </div><div class="line"><span class="keyword">from</span> flags <span class="keyword">import</span> BASE_URL, save_flag, show, main  </div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine  </span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span><span class="params">(cc)</span>:</span></div><div class="line">    url = <span class="string">'&#123;&#125;/&#123;cc&#125;/&#123;cc&#125;.gif'</span>.format(BASE_URL, cc=cc.lower())</div><div class="line">    resp = <span class="keyword">yield</span> <span class="keyword">from</span> aiohttp.request(<span class="string">'GET'</span>, url)  <span class="comment"># 1</span></div><div class="line">    image = <span class="keyword">yield</span> <span class="keyword">from</span> resp.read()  <span class="comment"># 2</span></div><div class="line">    <span class="keyword">return</span> image</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_one</span><span class="params">(cc)</span>:</span>  <span class="comment"># 3</span></div><div class="line">    image = <span class="keyword">yield</span> <span class="keyword">from</span> get_flag(cc)  </div><div class="line">    show(cc)</div><div class="line">    save_flag(image, cc.lower() + <span class="string">'.gif'</span>)</div><div class="line">    <span class="keyword">return</span> cc</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_many</span><span class="params">(cc_list)</span>:</span></div><div class="line">    loop = asyncio.get_event_loop()  <span class="comment"># 4</span></div><div class="line">    to_do = [download_one(cc) <span class="keyword">for</span> cc <span class="keyword">in</span> sorted(cc_list)]  </div><div class="line">    wait_coro = asyncio.wait(to_do)  <span class="comment"># 5</span></div><div class="line">    res, _ = loop.run_until_complete(wait_coro)  <span class="comment"># 6</span></div><div class="line">    loop.close() </div><div class="line">    <span class="keyword">return</span> len(res)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main(download_many)</div></pre></td></tr></table></figure>
<ol>
<li>非阻塞的操作通过协程实现，客户代码通过<code>yield from</code>把职责委托给协程，以便异步运行协程</li>
<li>读取相应内容是一项异步操作</li>
<li><code>download_one</code>函数也必须是协程，因为用到了<code>yield from</code></li>
<li>获取事件循环底层实现的引用</li>
<li><code>wait</code>是一个协程，等待给它的所有协程运行完毕后结束，把各个协程包装进一个<code>Task</code>对象</li>
<li>执行事件循环，直到<code>wait_coro</code>运行结束，事件循环运行的过程中，这个脚本会在这里阻塞。</li>
</ol>
<h3 id="避免阻塞型调用"><a href="#避免阻塞型调用" class="headerlink" title="避免阻塞型调用"></a>避免阻塞型调用</h3><p>有两种方法能避免阻塞型调用中止整个应用程序的进程：</p>
<ul>
<li>在单独的线程中运行个阻塞型操作，然后启用多线程，消耗的内存比较大</li>
<li>把每个阻塞型操作转换成非阻塞的异步调用使用</li>
</ul>
<h3 id="改进asycio下载脚本"><a href="#改进asycio下载脚本" class="headerlink" title="改进asycio下载脚本"></a>改进asycio下载脚本</h3><h4 id="使用asyncio-as-completed函数"><a href="#使用asyncio-as-completed函数" class="headerlink" title="使用asyncio.as_completed函数"></a>使用asyncio.as_completed函数</h4><p>原版把一个协程列表传给<code>asyncio.wait</code>函数，经由<code>loop.run_until_complete</code>方法驱动，全部协程运行结束后才能返回结果。可是为了更新进度条，各个协程运行结束后就要立即获取结果。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"><span class="keyword">import</span> collections</div><div class="line"><span class="keyword">import</span> contextlib</div><div class="line"></div><div class="line"><span class="keyword">import</span> aiohttp</div><div class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</div><div class="line"><span class="keyword">import</span> tqdm</div><div class="line"></div><div class="line"><span class="keyword">from</span> flags2_common <span class="keyword">import</span> main, HTTPStatus, Result, save_flag</div><div class="line"></div><div class="line"><span class="comment"># default set low to avoid errors from remote site, such as</span></div><div class="line"><span class="comment"># 503 - Service Temporarily Unavailable</span></div><div class="line">DEFAULT_CONCUR_REQ = <span class="number">5</span></div><div class="line">MAX_CONCUR_REQ = <span class="number">1000</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FetchError</span><span class="params">(Exception)</span>:</span>  <span class="comment"># &lt;1&gt;</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, country_code)</span>:</span></div><div class="line">        self.country_code = country_code</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span><span class="params">(base_url, cc)</span>:</span> <span class="comment"># &lt;2&gt;</span></div><div class="line">    url = <span class="string">'&#123;&#125;/&#123;cc&#125;/&#123;cc&#125;.gif'</span>.format(base_url, cc=cc.lower())</div><div class="line">    resp = <span class="keyword">yield</span> <span class="keyword">from</span> aiohttp.request(<span class="string">'GET'</span>, url)</div><div class="line">    <span class="keyword">with</span> contextlib.closing(resp):</div><div class="line">        <span class="keyword">if</span> resp.status == <span class="number">200</span>:</div><div class="line">            image = <span class="keyword">yield</span> <span class="keyword">from</span> resp.read()</div><div class="line">            <span class="keyword">return</span> image</div><div class="line">        <span class="keyword">elif</span> resp.status == <span class="number">404</span>:</div><div class="line">            <span class="keyword">raise</span> web.HTTPNotFound()</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">raise</span> aiohttp.HttpProcessingError(</div><div class="line">                code=resp.status, message=resp.reason,</div><div class="line">                headers=resp.headers)</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_one</span><span class="params">(cc, base_url, semaphore, verbose)</span>:</span>  <span class="comment"># &lt;3&gt;</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">with</span> (<span class="keyword">yield</span> <span class="keyword">from</span> semaphore):  <span class="comment"># &lt;4&gt;</span></div><div class="line">            image = <span class="keyword">yield</span> <span class="keyword">from</span> get_flag(base_url, cc)  <span class="comment"># &lt;5&gt;</span></div><div class="line">    <span class="keyword">except</span> web.HTTPNotFound:  </div><div class="line">        status = HTTPStatus.not_found</div><div class="line">        msg = <span class="string">'not found'</span></div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</div><div class="line">        <span class="keyword">raise</span> FetchError(cc) <span class="keyword">from</span> exc  </div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        save_flag(image, cc.lower() + <span class="string">'.gif'</span>)  </div><div class="line">        status = HTTPStatus.ok</div><div class="line">        msg = <span class="string">'OK'</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> verbose <span class="keyword">and</span> msg:</div><div class="line">        print(cc, msg)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Result(status, cc)</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">downloader_coro</span><span class="params">(cc_list, base_url, verbose, concur_req)</span>:</span>  <span class="comment"># 6</span></div><div class="line">    counter = collections.Counter()</div><div class="line">    semaphore = asyncio.Semaphore(concur_req)  <span class="comment"># 7</span></div><div class="line">    to_do = [download_one(cc, base_url, semaphore, verbose)</div><div class="line">             <span class="keyword">for</span> cc <span class="keyword">in</span> sorted(cc_list)]  </div><div class="line"></div><div class="line">    to_do_iter = asyncio.as_completed(to_do)  <span class="comment"># 8</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> verbose:</div><div class="line">        to_do_iter = tqdm.tqdm(to_do_iter, total=len(cc_list))  </div><div class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> to_do_iter:  </div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            res = <span class="keyword">yield</span> <span class="keyword">from</span> future  </div><div class="line">        <span class="keyword">except</span> FetchError <span class="keyword">as</span> exc:  </div><div class="line">            country_code = exc.country_code  </div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                error_msg = exc.__cause__.args[<span class="number">0</span>]  </div><div class="line">            <span class="keyword">except</span> IndexError:</div><div class="line">                error_msg = exc.__cause__.__class__.__name__  </div><div class="line">            <span class="keyword">if</span> verbose <span class="keyword">and</span> error_msg:</div><div class="line">                msg = <span class="string">'*** Error for &#123;&#125;: &#123;&#125;'</span></div><div class="line">                print(msg.format(country_code, error_msg))</div><div class="line">            status = HTTPStatus.error</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            status = res.status</div><div class="line"></div><div class="line">        counter[status] += <span class="number">1</span> </div><div class="line"></div><div class="line">    <span class="keyword">return</span> counter  </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_many</span><span class="params">(cc_list, base_url, verbose, concur_req)</span>:</span></div><div class="line">    loop = asyncio.get_event_loop()</div><div class="line">    coro = downloader_coro(cc_list, base_url, verbose, concur_req)</div><div class="line">    counts = loop.run_until_complete(coro)  <span class="comment"># 9</span></div><div class="line">    loop.close()  </div><div class="line"></div><div class="line">    <span class="keyword">return</span> counts</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main(download_many, DEFAULT_CONCUR_REQ, MAX_CONCUR_REQ)</div></pre></td></tr></table></figure>
<ol>
<li>自定义异常用于包装其他HTTP或网络异常，并获取<code>country_code</code>，以便报告错误</li>
<li><code>get_flag</code>协程有三种返回结果：返回下载得到的图像；HTTP响应码为404时，抛出<code>web.HTTPNotFound</code>异常；返回其他HTTP状态码时，抛出<code>aiohttp.HttpProcessingError</code>异常。</li>
<li><code>semaphore</code>参数是<code>asyncio.Semaphore</code>类的实例，<code>Semaphore</code>类是同步配置，用于限制并发请求数</li>
<li>在<code>yield from</code>表达式中把<code>semaphore</code>当成上下文管理器使用，防止阻塞整个系统，如果<code>semaphore</code>计数器的值是所允许的最大值，只有这个协程会阻塞。</li>
<li>退出这个<code>with</code>语句后，<code>semaphore</code>计数器的值会递减，解除阻塞可能在等待同一个<code>semaphore</code>对象的其他协程实例</li>
<li>这个协程的参数与<code>download_many</code>函数一致，但是不能直接调用。因为只要函数中<code>yield from</code>，函数就会变成协程，协程是不能直接调用的。</li>
<li>创建一个<code>asyncio.Semaphore</code>实例，最多允许激活<code>concur_req</code>个使用这个计数器的协程</li>
<li>获取一个迭代器，这个迭代器会在期物运行结束后返回期物</li>
<li><code>download_many</code>函数只是实例化<code>downloader_coro</code>协程，然后通过<code>run_until_complete</code>方法把它传给事件循环</li>
</ol>
<h4 id="使用Executor对象，防止阻塞事件循环"><a href="#使用Executor对象，防止阻塞事件循环" class="headerlink" title="使用Executor对象，防止阻塞事件循环"></a>使用Executor对象，防止阻塞事件循环</h4><p>访问本地文件系统可能也会阻塞</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_one</span><span class="params">(cc, base_url, semaphore, verbose)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">with</span> (<span class="keyword">yield</span> <span class="keyword">from</span> semaphore):</div><div class="line">            image = <span class="keyword">yield</span> <span class="keyword">from</span> get_flag(base_url, cc)</div><div class="line">    <span class="keyword">except</span> web.HTTPNotFound:</div><div class="line">        status = HTTPStatus.not_found</div><div class="line">        msg = <span class="string">'not found'</span></div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</div><div class="line">        <span class="keyword">raise</span> FetchError(cc) <span class="keyword">from</span> exc</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        loop = asyncio.get_event_loop()  <span class="comment"># &lt;1&gt;</span></div><div class="line">        loop.run_in_executor(<span class="keyword">None</span>,  <span class="comment"># &lt;2&gt;</span></div><div class="line">                save_flag, image, cc.lower() + <span class="string">'.gif'</span>)  <span class="comment"># &lt;3&gt;</span></div><div class="line">        status = HTTPStatus.ok</div><div class="line">        msg = <span class="string">'OK'</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> verbose <span class="keyword">and</span> msg:</div><div class="line">        print(cc, msg)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Result(status, cc)</div></pre></td></tr></table></figure>
<ol>
<li>获取事件循环对象的引用</li>
<li><code>run_in_executor</code>方法的第一个参数是<code>Executor</code>实例，如果设置为<code>None</code>，使用事件循环默认<code>ThreadPoolExecutor</code>实例</li>
<li>余下参数是可调用的对象，以及可调用对象的位置参数</li>
</ol>
<h3 id="从回调到期物和协程"><a href="#从回调到期物和协程" class="headerlink" title="从回调到期物和协程"></a>从回调到期物和协程</h3><p>如果需要协调异步请求，而不只是发起完全独立的请求，协调较之回调的好处会变得显而易见。避免陷入，<strong>回调地狱</strong>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"><span class="keyword">import</span> collections</div><div class="line"></div><div class="line"><span class="keyword">import</span> aiohttp</div><div class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</div><div class="line"><span class="keyword">import</span> tqdm</div><div class="line"></div><div class="line"><span class="keyword">from</span> flags2_common <span class="keyword">import</span> main, HTTPStatus, Result, save_flag</div><div class="line"></div><div class="line"><span class="comment"># default set low to avoid errors from remote site, such as</span></div><div class="line"><span class="comment"># 503 - Service Temporarily Unavailable</span></div><div class="line">DEFAULT_CONCUR_REQ = <span class="number">5</span></div><div class="line">MAX_CONCUR_REQ = <span class="number">1000</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FetchError</span><span class="params">(Exception)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, country_code)</span>:</span></div><div class="line">        self.country_code = country_code</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">http_get</span><span class="params">(url)</span>:</span></div><div class="line">    res = <span class="keyword">yield</span> <span class="keyword">from</span> aiohttp.request(<span class="string">'GET'</span>, url)</div><div class="line">    <span class="keyword">if</span> res.status == <span class="number">200</span>:</div><div class="line">        ctype = res.headers.get(<span class="string">'Content-type'</span>, <span class="string">''</span>).lower()</div><div class="line">        <span class="keyword">if</span> <span class="string">'json'</span> <span class="keyword">in</span> ctype <span class="keyword">or</span> url.endswith(<span class="string">'json'</span>):</div><div class="line">            data = <span class="keyword">yield</span> <span class="keyword">from</span> res.json()  <span class="comment"># &lt;1&gt;</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            data = <span class="keyword">yield</span> <span class="keyword">from</span> res.read()  <span class="comment"># &lt;2&gt;</span></div><div class="line">        <span class="keyword">return</span> data</div><div class="line"></div><div class="line">    <span class="keyword">elif</span> res.status == <span class="number">404</span>:</div><div class="line">        <span class="keyword">raise</span> web.HTTPNotFound()</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">raise</span> aiohttp.errors.HttpProcessingError(</div><div class="line">            code=res.status, message=res.reason,</div><div class="line">            headers=res.headers)</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_country</span><span class="params">(base_url, cc)</span>:</span></div><div class="line">    url = <span class="string">'&#123;&#125;/&#123;cc&#125;/metadata.json'</span>.format(base_url, cc=cc.lower())</div><div class="line">    metadata = <span class="keyword">yield</span> <span class="keyword">from</span> http_get(url)  <span class="comment"># &lt;3&gt;</span></div><div class="line">    <span class="keyword">return</span> metadata[<span class="string">'country'</span>]</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span><span class="params">(base_url, cc)</span>:</span></div><div class="line">    url = <span class="string">'&#123;&#125;/&#123;cc&#125;/&#123;cc&#125;.gif'</span>.format(base_url, cc=cc.lower())</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">yield</span> <span class="keyword">from</span> http_get(url)) <span class="comment"># &lt;4&gt;</span></div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_one</span><span class="params">(cc, base_url, semaphore, verbose)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">with</span> (<span class="keyword">yield</span> <span class="keyword">from</span> semaphore): <span class="comment"># &lt;5&gt;</span></div><div class="line">            image = <span class="keyword">yield</span> <span class="keyword">from</span> get_flag(base_url, cc)</div><div class="line">        <span class="keyword">with</span> (<span class="keyword">yield</span> <span class="keyword">from</span> semaphore):</div><div class="line">            country = <span class="keyword">yield</span> <span class="keyword">from</span> get_country(base_url, cc)</div><div class="line">    <span class="keyword">except</span> web.HTTPNotFound:</div><div class="line">        status = HTTPStatus.not_found</div><div class="line">        msg = <span class="string">'not found'</span></div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</div><div class="line">        <span class="keyword">raise</span> FetchError(cc) <span class="keyword">from</span> exc</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        country = country.replace(<span class="string">' '</span>, <span class="string">'_'</span>)</div><div class="line">        filename = <span class="string">'&#123;&#125;-&#123;&#125;.gif'</span>.format(country, cc)</div><div class="line">        loop = asyncio.get_event_loop()</div><div class="line">        loop.run_in_executor(<span class="keyword">None</span>, save_flag, image, filename)</div><div class="line">        status = HTTPStatus.ok</div><div class="line">        msg = <span class="string">'OK'</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> verbose <span class="keyword">and</span> msg:</div><div class="line">        print(cc, msg)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Result(status, cc)</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">downloader_coro</span><span class="params">(cc_list, base_url, verbose, concur_req)</span>:</span></div><div class="line">    counter = collections.Counter()</div><div class="line">    semaphore = asyncio.Semaphore(concur_req)</div><div class="line">    to_do = [download_one(cc, base_url, semaphore, verbose)</div><div class="line">             <span class="keyword">for</span> cc <span class="keyword">in</span> sorted(cc_list)]</div><div class="line"></div><div class="line">    to_do_iter = asyncio.as_completed(to_do)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> verbose:</div><div class="line">        to_do_iter = tqdm.tqdm(to_do_iter, total=len(cc_list))</div><div class="line">    <span class="keyword">for</span> future <span class="keyword">in</span> to_do_iter:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            res = <span class="keyword">yield</span> <span class="keyword">from</span> future</div><div class="line">        <span class="keyword">except</span> FetchError <span class="keyword">as</span> exc:</div><div class="line">            country_code = exc.country_code</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                error_msg = exc.__cause__.args[<span class="number">0</span>]</div><div class="line">            <span class="keyword">except</span> IndexError:</div><div class="line">                error_msg = exc.__cause__.__class__.__name__</div><div class="line">            <span class="keyword">if</span> verbose <span class="keyword">and</span> error_msg:</div><div class="line">                msg = <span class="string">'*** Error for &#123;&#125;: &#123;&#125;'</span></div><div class="line">                print(msg.format(country_code, error_msg))</div><div class="line">            status = HTTPStatus.error</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            status = res.status</div><div class="line"></div><div class="line">        counter[status] += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> counter</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">download_many</span><span class="params">(cc_list, base_url, verbose, concur_req)</span>:</span></div><div class="line">    loop = asyncio.get_event_loop()</div><div class="line">    coro = downloader_coro(cc_list, base_url, verbose, concur_req)</div><div class="line">    counts = loop.run_until_complete(coro)</div><div class="line">    loop.close()</div><div class="line"></div><div class="line">    <span class="keyword">return</span> counts</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main(download_many, DEFAULT_CONCUR_REQ, MAX_CONCUR_REQ)</div></pre></td></tr></table></figure>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    Last updated: <time datetime="2018-03-29T09:57:49.000Z" itemprop="dateUpdated">2018-03-29 17:57:49</time>
</span><br>


        
    </div>
    <footer>
        <a href="http://printxhl.com">
            <img src="/img/avatar.jpg" alt="谢海练">
            谢海练
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li></ul>


            


        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2018/05/30/Linux-HexoBlog/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">Hexo Blog</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2018/05/30/Python-FlunetPython-data/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Fluent Python (1)：数据结构</h4>
      </a>
    </div>
  
</nav>



    














</article>



</div>

        <!-- <footer class="footer">
    <div class="top">
        

        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>footer.license</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>谢海练 &copy; 2017 - 2018</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer> -->

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>


    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: false, REWARD: false };


</script>

<script src="/js/main.min.js?v=1.6.13"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.6.13" async></script>



<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" async></script>








</body>
</html>
